{% extends 'base/admin.html' %}
{% load static %}
{% block title %}
  Admin Accounts Management
{% endblock %}
{% block stylesheet %}
  <link rel="stylesheet" href="{% static 'style/admin.css/admin.commodities.css' %}" />
{% endblock %}

{% block content %}
  <br />
  <div class="main-content" id="main-content">
    <div class="container">
      <h3 style="font-weight:bold;">ADMIN ACCOUNTS MANAGEMENT</h3>
      <hr style="color: black;" />
      <div class="animated fadeIn">
        <!-- Widgets -->
        <div class="row">
          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="stat-widget-five">
                  <div class="stat-icon dib flat-color-3">
                    <span class="mdi mdi-account-group-outline"></span>
                  </div>
                  <div class="stat-content">
                    <div class="text-left dib">
                      <div class="stat-text">
                        <span class="count">
                          {% if total_gen_user %}
                            {{ total_gen_user }}
                          {% else %}
                            0
                          {% endif %}
                        </span>
                      </div>
                      <div class="stat-heading">General User</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="stat-widget-five">
                  <div class="stat-icon dib flat-color-sec">
                    <span class="mdi mdi-account-group-outline"></span>
                  </div>
                  <div class="stat-content">
                    <div class="text-left dib">
                      <div class="stat-text">
                        <span class="count">
                          {% if total_sec_user %}
                            {{ total_sec_user }}
                          {% else %}
                            0
                          {% endif %}
                        </span>
                      </div>
                      <div class="stat-heading">Secretariat User</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="stat-widget-five">
                  <div class="stat-icon dib flat-color-cmi">
                    <span class="mdi mdi-account-group-outline"></span>
                  </div>
                  <div class="stat-content">
                    <div class="text-left dib">
                      <div class="stat-text">
                        <span class="count">
                          {% if total_cmi_user %}
                            {{ total_cmi_user }}
                          {% else %}
                            0
                          {% endif %}
                        </span>
                      </div>
                      <div class="stat-heading">CMI/s User</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-3 col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="stat-widget-five">
                  <div class="stat-icon dib flat-color-2">
                    <span class="mdi mdi-account-group-outline"></span>
                  </div>
                  <div class="stat-content">
                    <div class="text-left dib">
                      <div class="stat-text">
                        <span class="count">
                          {% if total_accounts %}
                            {{ total_accounts }}
                          {% else %}
                            0
                          {% endif %}
                        </span>
                      </div>
                      <div class="stat-heading">Total Accounts</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br />
      <div class="row" style="display: grid; margin: auto;">
        <div class="doughnut" style="border: #0C356A 1px solid; border-radius: 4px;">
          <h3></h3>
          <canvas id="userChart" style="height: 150px; width: auto; margin: 10px 10px 10px 40px;"></canvas>
        </div>
      </div>

      <hr />
      <div class="table-container">
        <table id="accountsTable" class="accounts-table table table-bordered">
          <thead style="color: #fff; font-size: 13px; background-color: #0C356A; font-weight: bolder;">
            <tr>
              <th style="width: 8px;">ID</th>
              <th>Name</th>
              <th>Date Joined</th>
              <th>Email</th>
              <th>Institution</th>
              <th>Position</th>
              <th>Occupation</th>
              <th>User Type</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody style="font-size: 12px;">
            {% for user in users %}
              <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.first_name }} {{ user.last_name }}</td>
                <td>{{ user.date_joined|date:'Y-m-d' }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.institution }}</td>
                <td>{{ user.position }}</td>
                <td>{{ user.occupation }}</td>
                <td>{{ user.user_type|capfirst }}</td>
                <td>
                  <button type="button" style="background-color: #FFC436; color: #fff;" class="btn btn-sm view-btn" data-toggle="modal" data-target="#editAccountModal" data-userid="{{ user.id }}" data-firstname="{{ user.first_name }}" data-lastname="{{ user.last_name }}" data-datejoined="{{ user.date_joined|date:'Y-m-d' }}" data-email="{{ user.email }}" data-institution="{{ user.institution }}" data-position="{{ user.position }}" data-occupation="{{ user.occupation }}" data-usertype="{{ user.user_type }}"><i class="fa-solid fa-pen-to-square"></i></button>
                  <button type="button" style="background-color: #0174BE; color: #fff" class="btn btn-sm view-btn" data-toggle="modal" data-target="#viewAccountModal" data-userid="{{ user.id }}" data-firstname="{{ user.first_name }}" data-lastname="{{ user.last_name }}" data-datejoined="{{ user.date_joined|date:'Y-m-d' }}" data-email="{{ user.email }}" data-institution="{{ user.institution }}" data-position="{{ user.position }}" data-occupation="{{ user.occupation }}" data-usertype="{{ user.user_type }}"><i class="fa-solid fa-eye"></i></button>
                  <a data-placement="top" data-toggle="tooltip" title="delete" href="/delete-account/{{ user.id }}" class="btn btn-danger btn-sm"><i class="fa-solid fa-trash"></i></a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% include 'accounts/admin/modals/account/add_account.html' %}
  {% include 'accounts/admin/modals/account/edit_account.html' %}
  {% include 'accounts/admin/modals/account/view_account.html' %}
{% endblock %}

{% block script %}
  {% if messages %}
    {% for message in messages %}
      {% if message.tags == 'success' %}
        <script>
          // Display SweetAlert success message
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '{{ message }}'
          })
        </script>
        {% else %}
        <script>
          // Display SweetAlert success message
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: '{{ message }}'
          })
        </script>
      {% endif %}
    {% endfor %}
  {% endif %}
  <script>
    const userLabels = ['General Users', 'Secretariat Users', 'CMI Users'];

    const pie = document.getElementById('userChart').getContext('2d');
    const statusChart = new Chart(pie, {
      type: 'bar',
      data: {
        labels: userLabels, // Labels for the data points
        datasets: [{
          label: 'General Users', // Label for the first dataset
          data: [{{ total_gen_user|safe }}, null, null], // Use actual value for the first dataset
          backgroundColor: 'rgba(0, 123, 255, 0.6)',
          borderColor: 'rgba(0, 123, 255, 1)',
          borderWidth: 1,
        }, {
          label: 'Secretariat Users', // Label for the second dataset
          data: [null, {{ total_sec_user|safe }}, null], // Use actual value for the second dataset
          backgroundColor: 'rgba(255, 193, 7, 0.6)',
          borderColor: 'rgba(255, 193, 7, 1)',
          borderWidth: 1,
        }, {
          label: 'CMI Users', // Label for the third dataset
          data: [null, null, {{ total_cmi_user|safe }}], // Use actual value for the third dataset
          backgroundColor: 'rgba(255, 99, 132, 0.6)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        indexAxis: 'y', // Display bars horizontally
        plugins: {
          legend: {
            display: true,
            position: 'right', // Position the legend to the right
          },
          // Configure the DataLabels plugin to display values inside the bars horizontally
          datalabels: {
            anchor: 'end',
            align: 'end',
            formatter: (value, context) => value, // Display the actual value
          },
          // Add a title for the chart
          title: {
            display: true,
            text: 'User Category Distribution', // Title for the chart
            font: {
              size: 20
            }
          }
        },
        scales: {
          x: {
            display: true,
            beginAtZero: true,
            title: {
              display: true,
              text: 'Count' // Label for the x-axis
            },
            ticks: {
              stepSize: 1
            }
          }
        },
        skipNull: true, // Skip null values in datasets
      }
    });

    //view account modal
    $(document).ready(function () {
      $('.view-btn').on('click', function () {
        var userId = $(this).data('userid')
        var firstName = $(this).data('firstname')
        var lastName = $(this).data('lastname')
        var dateJoined = $(this).data('datejoined')
        var userEmail = $(this).data('email')
        var institution = $(this).data('institution')
        var position = $(this).data('position')
        var occupation = $(this).data('occupation')
        var userType = $(this).data('usertype')
    
        // Capitalize first letter of first name and last name
        var capitalizedFirstName = firstName.charAt(0).toUpperCase() + firstName.slice(1)
        var capitalizedLastName = lastName.charAt(0).toUpperCase() + lastName.slice(1)
    
        // Capitalize first letter of user type
        var capitalizedUserType = userType.charAt(0).toUpperCase() + userType.slice(1)
    
        $('#viewAccountModal').find('#viewAccountId').text(userId)
        $('#viewAccountModal')
          .find('#viewAccountName')
          .text(capitalizedFirstName + ' ' + capitalizedLastName)
        $('#viewAccountModal').find('#viewAccountDate').text(dateJoined)
        $('#viewAccountModal').find('#viewAccountEmail').text(userEmail)
        $('#viewAccountModal').find('#viewAccountInstitution').text(institution)
        $('#viewAccountModal').find('#viewAccountPosition').text(position)
        $('#viewAccountModal').find('#viewAccountOccupation').text(occupation)
        $('#viewAccountModal').find('#viewAccountUsertype').text(capitalizedUserType)
      })
    })
    
    
    //edit account modal
    $(document).ready(function () {
      // Event listener for the edit button
      $('.view-btn').on('click', function () {
        var userId = $(this).data('userid')
        var firstName = $(this).data('firstname')
        var lastName = $(this).data('lastname')
        var dateJoined = $(this).data('datejoined')
        var userEmail = $(this).data('email')
        var institution = $(this).data('institution')
        var position = $(this).data('position')
        var occupation = $(this).data('occupation')
        var userType = $(this).data('usertype')
    
        // Populate modal fields with user-specific data
        $('#editAccountModal').find('#first_name').val(firstName)
        $('#editAccountModal').find('#last_name').val(lastName)
        $('#editAccountModal').find('#email').val(userEmail)
        $('#editAccountModal').find('#institution').val(institution)
        $('#editAccountModal').find('#position').val(position)
        $('#editAccountModal').find('#occupation').val(occupation)
        $('#editAccountModal').find('#user_type').val(userType)
    
        // Update form action attribute with the user ID
        $('#editAccountModal')
          .find('form')
          .attr('action', '/edit-account/' + userId + '/')
      })
    })
    
    //add account modal
    function addAccount() {
      // Logic to handle adding data goes here
      console.log('Add Data button clicked')
      // Add your logic here for adding data
      $('#accountRegistrationModal').modal('show')
    }
    $(document).ready(function () {
      let table = $('#accountsTable').DataTable({
        language: {
          lengthMenu: '_MENU_',
          search: '',
          searchPlaceholder: 'Search...'
        },
        lengthMenu: [
          [7, 10, 25, -1],
          [7, 10, 25, 'All']
        ],
        paging: true,
        lengthChange: true,
        autoWidth: false,
        bInfo: true,
        bSort: true,
        responsive: true,
        buttons: [
          {
            text: 'CSV',
            extend: 'csv'
          },
          {
            text: 'PDF',
            extend: 'pdf'
          },
          {
            text: 'ADD',
            className: 'btn btn-primary',
            action: function () {
              addAccount()
            }
          }
        ],
        dom: '<"row"<"col-md-1"l><"col-md-8"B><"col-md-3"f>>' + '<"row"<"col-md-12"tr>>' + '<"row"<"col-md-5"i><"col-md-7"p>>'
      })
    })
  </script>
{% endblock %}
