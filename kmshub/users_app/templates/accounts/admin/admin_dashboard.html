{% extends 'base/admin.html' %}
{% load static %}
{% block title %}
  Admin Dashboard
{% endblock %}
{% block stylesheet %}
  <link rel="stylesheet" href="{% static 'style/admin.css/admin.dashboard.css' %}" />
{% endblock %}

{% block content %}
  <br />
  <div class="main-content" id="main-content">
    <div class="container">
      <h3 style="font-weight:bold; background-color: #0C356A; color: white;">ADMIN DATA VISUALIZATION DASHBOARD</h3>
      <hr />
      <div class="card-container" id="total-container">
        <div class="animated fadeIn">
          <div class="row">
            <div class="col-lg-3 col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="stat-widget-five">
                    <div class="stat-icon dib flat-color-3">
                      <span class="mdi mdi-account-group-outline"></span>
                    </div>
                    <div class="stat-content">
                      <div class="text-left dib">
                        <div class="stat-text">
                          <span class="count">
                            {% if user_statistics.total_accounts %}
                              {{ user_statistics.total_accounts }}
                            {% else %}
                              0
                            {% endif %}
                          </span>
                        </div>
                        <div class="stat-heading"><a href="{% url 'admin-accounts' %}" class="stat-heading"> Total Users</a> </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            

            <!-- Total Commodities -->
            <div class="col-lg-3 col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="stat-widget-five">
                    <div class="stat-icon dib flat-color-5">
                      <span class="mdi mdi-barley"></span>
                    </div>
                    <div class="stat-content">
                      <div class="text-left dib">
                        <div class="stat-text">
                          <span class="count">
                            {% if commodity_statistics.total_commodities %}
                              {{ commodity_statistics.total_commodities }}
                            {% else %}
                              0
                            {% endif %}
                          </span>
                        </div>
                        <div class="stat-heading"><a href="{% url 'admin-commodities' %}" class="stat-heading"> Total Commodity</a> </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <!-- Total Knowledge Resources -->
            <div class="col-lg-3 col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="stat-widget-five">
                    <div class="stat-icon dib flat-color-cmi">
                      <span class="mdi mdi-database"></span>
                    </div>
                    <div class="stat-content">
                      <div class="text-left dib">
                        <div class="stat-text">
                          <span class="count">
                            {% if total_resource %}
                              {{ total_resource }}
                            {% else %}
                              0
                            {% endif %}
                          </span>
                        </div>
                        <div class="stat-heading"><a href="{% url 'admin-knowledge' %}" class="stat-heading"> Total Resources</a> </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Total Search --> <!-- Total Filtered Commodities -->
            <div class="col-lg-3 col-md-6">
              <div class="card">
                <div class="card-body">
                  <div class="stat-widget-five">
                    <div class="stat-icon dib flat-color-2">
                      <span class="mdi mdi-magnify"></span>
                    </div>
                    <div class="stat-content">
                      <div class="text-left dib">
                        <div class="stat-text">
                          <span class="count">
                            {% if total_search %}
                              {{ total_search }}
                            {% else %}
                              0
                            {% endif %}
                          </span>
                        </div>
                        <div class="stat-heading"><a href="{% url 'admin-search' %}" class="stat-heading"> Total Search</a> </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br />
      <div class="card-container" id="visual-container">
        <div class="row">
          <div class="col-12 col-md-6">
            <div class="card">
              <div class="card-content">
                <div class="card-body">
                  <h3 style="font-weight:bold; background-color: #0C356A; color: white;">REGISTERED USERS VISUALIZATION</h3>
                  <canvas id="usersChart" style="height: 250px;"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="card">
              <div class="card-content">
                <div class="card-body">
                  <h3 style="font-weight:bold; background-color: #0C356A; color: white;">TAGGED COMMODITIES CHART</h3>
                  <canvas id="taggedCommoditiesChart" style="height: 250px;"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
        <br />
        <div class="row">
          <div class="col-12 col-md-6">
            <div class="card">
              <div class="card-content">
                <div class="card-body">
                  <h3 style="font-weight:bold; background-color: #0C356A; color: white;">SEARCH TERM VISUALIZATION</h3>
                  <canvas id="searchTermChart" style="height: 250px;"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="card">
              <div class="card-content">
                <div class="card-body">
                  <h3 style="font-weight:bold; background-color: #0C356A; color: white;">DAILY POSTS VISUALIZATION</h3>
                  <canvas id="postsChart" style="height: 250px;"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  {% if messages %}
    {% for message in messages %}
      {% if message.tags == 'success' %}
        <script>
          // Display SweetAlert success message
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '{{ message }}'
          })
        </script>
      {% endif %}
    {% endfor %}
  {% endif %}
  <script>
    // Create the chart for user statistics
    const ctx = document.getElementById('usersChart').getContext('2d');
    const usersChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: {{ user_statistics.month_labels|safe }},
            datasets: [{
                label: 'User Count',
                data: {{ user_statistics.user_counts|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1,
            }, {
                label: 'User Count Line',
                data: {{ user_statistics.user_counts|safe }},
                type: 'line',
                fill: false,
                borderColor: 'rgba(255, 99, 132, 1)',
                pointRadius: 5,
                yAxisID: 'y2',
            }]
        },
        options: {
            responsive: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        suggestedMin: 1,
                        suggestedMax: 100,
                    },
                    title: {
                        display: true,
                        text: 'User Count (Bar)'
                    }
                },
                y2: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        suggestedMin: 1,
                        suggestedMax: 100,
                    },
                    position: 'right',
                    grid: {
                        display: false,
                    },
                    title: {
                        display: true,
                        text: 'User Count (Line)'
                    }
                }
            }
        }
    });

    // Assuming 'commodity_statistics' is available in your template
    const commodityStatistics = {{ commodity_statistics|safe }};
    console.log("Knowledge Labels:", {{ knowledge_labels|safe }});

    // Extracting commodity names and tagged counts
    const commodityNames = commodityStatistics.tagged_counts.map(entry => entry.commodity_name);
    const taggedCounts = commodityStatistics.tagged_counts.map(entry => entry.total_tags);

    // Now you can use commodityNames and taggedCounts in your chart creation
    const pie = document.getElementById('taggedCommoditiesChart').getContext('2d');
    const taggedCommoditiesChart = new Chart(pie, {
        type: 'pie',
        data: {
            labels: commodityNames,
            datasets: [{
                data: taggedCounts,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1,
            }]
        },
        options: {
            responsive: false,
            plugins: {
                datalabels: {
                    display: true,
                    formatter: (value, context) => {
                        const commodityName = context.chart.data.labels[context.dataIndex];
                        const tagPercentage = tagPercentages[context.dataIndex];
                        return `${commodityName}: ${value} (Tag Percentage: ${tagPercentage}%)`;
                    },
                    color: '#fff',
                    backgroundColor: 'rgba(0, 0, 0, 0.7)',
                    borderRadius: 4,
                    anchor: 'end',
                    align: 'end',
                }
            }
        }
    });


    // Assuming 'search_terms', 'frequencies', 'filtered_commodity_names', and 'filtered_commodity_frequencies' are available in your template
    const searchTerms = {{ search_terms|safe }};
    const frequencies = {{ frequencies|safe }};
    const filteredCommodityNames = {{ filtered_commodity_names|safe }};
    const filteredCommodityFrequencies = {{ filtered_commodity_frequencies|safe }}; 
    const capitalizedSearchTerms = searchTerms.map(name => name.charAt(0).toUpperCase() + name.slice(1));

    // Get the canvas context
    const lines = document.getElementById('searchTermChart').getContext('2d');

    // Create the line chart
    const searchTermChart = new Chart(lines, {
      type: 'line',
      data: {
        labels: capitalizedSearchTerms, // Use the array of unique terms
        datasets: [
          {
            label: 'Search Term Frequencies',
            data: frequencies, // Use the full frequencies array
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1,
            fill: true // Handle missing values at the end
          },
        ]
      },
      options: {
        responsive: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Frequency'
            },
            ticks: {
              stepSize: 1, // Force ticks to be integers
              precision: 0 // Ensure that there are no decimal points
            }
          },
          x: {
            beginAtZero: true,
            title: {
              display: true,
              text: ' Search Terms'
            }
          }
        }
      }
    });


   // Assuming 'daily_labels' and 'daily_discussion_counts' are available in your template
  const dailyLabels = {{ daily_labels|safe }};
  const dailyDiscussionCounts = {{ daily_discussion_counts|safe }};

  // Parse the discussion counts as integers
  const parsedDiscussionCounts = dailyDiscussionCounts.map(function(count) {
      return parseInt(count, 10); // This will parse the count as an integer
  });

  // Get the canvas context
  const barChart = document.getElementById('postsChart').getContext('2d');

  // Create the bar chart
  const postsChart = new Chart(barChart, {
      type: 'bar',
      data: {
          labels: dailyLabels,
          datasets: [{
              label: 'Daily Discussion Counts',
              data: parsedDiscussionCounts,
              backgroundColor: 'rgba(75, 192, 192, 0.7)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1
          }]
      },
      options: {
        responsive: false,
        scales: {
            y: {
                type: 'linear', // Set type to linear for integer values
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Total Discussions'
                },
                ticks: {
                    stepSize: 1, // Force ticks to be integers
                    precision: 0, // Ensure that there are no decimal points
                }
            },
            x: {  // Change x to xAxis
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Day'
                }
            }
        }
    }
  });
</script>
{% endblock %}
